<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dasm</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="topbar">
        <div class="tabs-container">
            <button class="tab active">graph.smd</button>
            <button class="tab">graph.dasm</button>
            <button class="tab">graph.wat</button>
        </div>
        <div class="logo">.dasm</div>
        <div class="topbar-buttons">
            <button class="topbar-button">Compile</button>
            <button class="topbar-button">Export</button>
            <button class="topbar-button">Settings</button>
        </div>
    </div>

    <div class="main-container">
        <div class="editor-panel">
            <div id="editor-container"></div>
        </div>

        <div class="separator" id="separator"></div>

        <div class="canvas-panel">
            <div class="canvas-controls">
                <button class="canvas-button" id="homeButton" title="Reset View">⌂</button>
            </div>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <!-- DASM Compiler -->
    <script src="smd_tokenizer.js"></script>
    <script src="dasm_compiler.js"></script>
    <script src="dasm_runtime.js"></script>

    <!-- Editor Configuration -->
    <script src="editor.js"></script>

    <!-- Canvas Configuration -->
    <script src="canvas.js"></script>

    <!-- UI Interactions -->
    <script>
        // Initialize DASM Runtime
        const dasmRuntime = new DasmRuntime();

        // Draggable separator
        const separator = document.getElementById('separator');
        const editorPanel = document.querySelector('.editor-panel');
        const canvasPanel = document.querySelector('.canvas-panel');
        let isDragging = false;

        separator.addEventListener('mousedown', (e) => {
            isDragging = true;
            separator.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const containerRect = document.querySelector('.main-container').getBoundingClientRect();
            const newLeftWidth = e.clientX - containerRect.left;
            const totalWidth = containerRect.width;
            const minWidth = 200;

            if (newLeftWidth > minWidth && (totalWidth - newLeftWidth) > minWidth) {
                const leftFlex = newLeftWidth / totalWidth;
                const rightFlex = (totalWidth - newLeftWidth) / totalWidth;

                editorPanel.style.flexGrow = leftFlex;
                editorPanel.style.flexShrink = leftFlex;
                canvasPanel.style.flexGrow = rightFlex;
                canvasPanel.style.flexShrink = rightFlex;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                separator.classList.remove('dragging');
                document.body.style.cursor = 'default';
                resizeCanvas(); // Resize canvas after separator drag
            }
        });

        // Run button - compile smd to dasm
        document.querySelector('.topbar-buttons .topbar-button').addEventListener('click', function() {
            if (this.textContent == 'Compile') {
                try {
                    // Get the smd code from editor
                    const smdCode = tabContents['graph.smd'];

                    // Compile smd to dasm
                    const dasmCode = dasmRuntime.compile(smdCode);

                    // Update the dasm tab
                    tabContents['graph.dasm'] = dasmCode;

                    // If we're on the dasm tab, update the editor
                    if (currentTab === 'graph.dasm') {
                        editor.setValue(dasmCode);
                    }

                    // Visual feedback
                    this.textContent = 'Compiled ✓';
                    this.style.background = '#21a343';
                    setTimeout(() => {
                        this.textContent = 'Run';
                        this.style.background = '#3e3e42';
                    }, 1500);

                } catch (error) {
                    console.error('Compilation error:', error);

                    // Show error feedback
                    this.textContent = 'Error ✗';
                    this.style.background = '#d32f2f';
                    setTimeout(() => {
                        this.textContent = 'Run';
                        this.style.background = '#3e3e42';
                    }, 2000);

                    // Log error to dasm tab
                    const errorMessage = `; COMPILATION ERROR\n; ${error.message}\n\n${error.stack || ''}`;
                    tabContents['graph.dasm'] = errorMessage;
                    if (currentTab === 'graph.dasm') {
                        editor.setValue(errorMessage);
                    }
                }
            }
        });
    </script>
</body>
</html>